<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>바코드 재고 관리 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #reader {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-4 md:p-6">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600 dark:text-blue-400">바코드 재고 관리 시스템</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">창고 위치를 스캔하고 재고를 관리하세요.</p>
        </header>

        <!-- 설정 섹션 -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-3 border-b pb-2">초기 설정</h2>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="url" id="appsScriptUrl" placeholder="Google Apps Script URL을 여기에 붙여넣으세요" class="flex-grow p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <button id="saveUrlButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors">URL 저장</button>
            </div>
            <p id="urlStatus" class="text-sm mt-2 text-green-600 dark:text-green-400"></p>
        </div>

        <!-- 탭 메뉴 -->
        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-manager" class="tab-button py-3 px-1 border-b-2 border-transparent text-lg text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 transition-colors active" data-tab="manager">재고 관리</button>
                <button id="tab-generator" class="tab-button py-3 px-1 border-b-2 border-transparent text-lg text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 transition-colors" data-tab="generator">바코드 생성기</button>
            </nav>
        </div>

        <!-- 재고 관리 탭 -->
        <main id="manager-tab" class="space-y-6">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3">1. 위치 스캔</h2>
                <div id="scanner-container" class="flex flex-col items-center gap-4">
                    <div id="reader" class="hidden"></div>
                    <button id="scanButton" class="w-full max-w-sm bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-md transition-colors text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        스캔 시작
                    </button>
                    <p id="scanResult" class="text-center font-mono text-lg p-2 bg-gray-100 dark:bg-gray-700 rounded-md hidden"></p>
                </div>
            </div>

            <div id="inventory-section" class="hidden space-y-6">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-3">2. 현재 재고 현황</h2>
                    <div id="current-inventory" class="min-h-[50px]">
                        <p class="text-gray-500">위치를 스캔하여 재고를 확인하세요.</p>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-3">3. 재고 처리</h2>
                    <form id="inventoryForm" class="space-y-4">
                        <div>
                            <label for="productId" class="block text-sm font-medium text-gray-700 dark:text-gray-300">제품 ID (바코드 또는 번호)</label>
                            <input type="text" id="productId" required class="mt-1 block w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label for="productName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">제품명</label>
                            <input type="text" id="productName" required class="mt-1 block w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300">수량</label>
                            <input type="number" id="quantity" required min="1" class="mt-1 block w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <fieldset>
                            <legend class="text-sm font-medium text-gray-700 dark:text-gray-300">작업</legend>
                            <div class="mt-2 space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="action" value="IN" class="form-radio text-blue-600" checked>
                                    <span class="ml-2">입고</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="action" value="OUT" class="form-radio text-red-600">
                                    <span class="ml-2">출고</span>
                                </label>
                            </div>
                        </fieldset>
                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-md transition-colors text-lg">처리 완료</button>
                    </form>
                </div>
            </div>
        </main>

        <!-- 바코드 생성기 탭 -->
        <div id="generator-tab" class="hidden">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-3">위치 바코드 생성기</h2>
                <div class="flex flex-col sm:flex-row gap-2 mb-4">
                    <input type="text" id="barcodeValue" placeholder="위치 ID 입력 (예: A01-S01-B01)" class="flex-grow p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <button id="generateBarcodeBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors">바코드 생성</button>
                </div>
                <div id="barcodeContainer" class="flex justify-center items-center bg-white p-4 rounded-md min-h-[150px]">
                    <svg id="barcode"></svg>
                </div>
            </div>
        </div>
        
        <!-- 상태 메시지 -->
        <div id="statusMessage" class="mt-6 p-4 rounded-lg text-center font-semibold hidden"></div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const appsScriptUrlInput = document.getElementById('appsScriptUrl');
            const saveUrlButton = document.getElementById('saveUrlButton');
            const urlStatus = document.getElementById('urlStatus');
            
            const scanButton = document.getElementById('scanButton');
            const readerDiv = document.getElementById('reader');
            const scanResult = document.getElementById('scanResult');
            const inventorySection = document.getElementById('inventory-section');
            const currentInventoryDiv = document.getElementById('current-inventory');
            const inventoryForm = document.getElementById('inventoryForm');
            const statusMessage = document.getElementById('statusMessage');

            const tabManager = document.getElementById('tab-manager');
            const tabGenerator = document.getElementById('tab-generator');
            const managerTabContent = document.getElementById('manager-tab');
            const generatorTabContent = document.getElementById('generator-tab');
            
            const generateBarcodeBtn = document.getElementById('generateBarcodeBtn');
            const barcodeValueInput = document.getElementById('barcodeValue');
            const barcodeContainer = document.getElementById('barcodeContainer');

            let html5QrCode;
            let currentScannedLocation = null;
            let SCRIPT_URL = '';

            // 탭 기능 구현
            function switchTab(activeTab) {
                [tabManager, tabGenerator].forEach(tab => tab.classList.remove('active'));
                [managerTabContent, generatorTabContent].forEach(content => content.classList.add('hidden'));

                if (activeTab === 'manager') {
                    tabManager.classList.add('active');
                    managerTabContent.classList.remove('hidden');
                } else {
                    tabGenerator.classList.add('active');
                    generatorTabContent.classList.remove('hidden');
                }
            }
            tabManager.addEventListener('click', () => switchTab('manager'));
            tabGenerator.addEventListener('click', () => switchTab('generator'));

            // URL 저장 및 로드
            saveUrlButton.addEventListener('click', () => {
                const url = appsScriptUrlInput.value.trim();
                if (url) {
                    localStorage.setItem('appsScriptUrl', url);
                    SCRIPT_URL = url;
                    urlStatus.textContent = 'URL이 성공적으로 저장되었습니다.';
                    urlStatus.className = 'text-sm mt-2 text-green-600 dark:text-green-400';
                } else {
                    urlStatus.textContent = '유효한 URL을 입력해주세요.';
                    urlStatus.className = 'text-sm mt-2 text-red-600 dark:text-red-400';
                }
            });

            function loadUrl() {
                const savedUrl = localStorage.getItem('appsScriptUrl');
                if (savedUrl) {
                    appsScriptUrlInput.value = savedUrl;
                    SCRIPT_URL = savedUrl;
                    urlStatus.textContent = '저장된 URL을 불러왔습니다.';
                    urlStatus.className = 'text-sm mt-2 text-green-600 dark:text-green-400';
                }
            }

            // 상태 메시지 표시 함수
            function showStatus(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.className = `mt-6 p-4 rounded-lg text-center font-semibold ${isError ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`;
                statusMessage.classList.remove('hidden');
                setTimeout(() => statusMessage.classList.add('hidden'), 5000);
            }

            // 바코드 스캐너 초기화 및 시작
            scanButton.addEventListener('click', () => {
                if (!SCRIPT_URL) {
                    showStatus('먼저 Google Apps Script URL을 설정하고 저장해주세요.', true);
                    return;
                }

                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("reader");
                }

                if (scanButton.textContent.includes('시작')) {
                    readerDiv.classList.remove('hidden');
                    scanButton.textContent = '스캔 중지';
                    scanButton.classList.replace('bg-indigo-500', 'bg-red-500');
                    scanButton.classList.replace('hover:bg-indigo-600', 'hover:bg-red-600');
                    
                    html5QrCode.start(
                        { facingMode: "environment" },
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        onScanSuccess,
                        (errorMessage) => { /* console.log(errorMessage); */ }
                    ).catch((err) => {
                        showStatus('카메라를 시작할 수 없습니다. 권한을 확인해주세요.', true);
                        stopScanner();
                    });
                } else {
                    stopScanner();
                }
            });

            function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        readerDiv.classList.add('hidden');
                        scanButton.textContent = '스캔 시작';
                        scanButton.classList.replace('bg-red-500', 'bg-indigo-500');
                        scanButton.classList.replace('hover:bg-red-600', 'hover:bg-indigo-600');
                    }).catch(err => console.error("Scanner stop failed", err));
                }
            }

            // 스캔 성공 시
            function onScanSuccess(decodedText, decodedResult) {
                stopScanner();
                currentScannedLocation = decodedText;
                scanResult.textContent = `스캔된 위치: ${decodedText}`;
                scanResult.classList.remove('hidden');
                inventorySection.classList.remove('hidden');
                fetchInventory(decodedText);
            }

            // 재고 정보 가져오기
            async function fetchInventory(locationId) {
                currentInventoryDiv.innerHTML = '<p class="text-gray-500">재고 정보를 불러오는 중...</p>';
                try {
                    const response = await fetch(`${SCRIPT_URL}?location=${locationId}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();

                    if (data.inventory && data.inventory.length > 0) {
                        let tableHtml = `
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">제품 ID</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">제품명</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">수량</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">`;
                        data.inventory.forEach(item => {
                            tableHtml += `
                                <tr>
                                    <td class="px-4 py-2 whitespace-nowrap font-mono">${item.ProductID}</td>
                                    <td class="px-4 py-2 whitespace-nowrap">${item.ProductName}</td>
                                    <td class="px-4 py-2 whitespace-nowrap font-bold">${item.Quantity}</td>
                                </tr>`;
                        });
                        tableHtml += `</tbody></table></div>`;
                        currentInventoryDiv.innerHTML = tableHtml;
                    } else {
                        currentInventoryDiv.innerHTML = '<p class="text-gray-500">해당 위치에 재고가 없습니다.</p>';
                    }
                } catch (error) {
                    console.error('Fetch inventory error:', error);
                    showStatus('재고 정보를 불러오는 데 실패했습니다.', true);
                    currentInventoryDiv.innerHTML = '<p class="text-red-500">오류 발생: 재고 정보를 불러올 수 없습니다.</p>';
                }
            }

            // 재고 처리 폼 제출
            inventoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentScannedLocation) {
                    showStatus('먼저 위치를 스캔해주세요.', true);
                    return;
                }

                const formData = {
                    locationId: currentScannedLocation,
                    productId: document.getElementById('productId').value,
                    productName: document.getElementById('productName').value,
                    quantity: document.getElementById('quantity').value,
                    action: document.querySelector('input[name="action"]:checked').value,
                };
                
                const submitButton = inventoryForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = '처리 중...';

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Apps Script는 리디렉션을 반환하므로 no-cors 모드 사용
                        cache: 'no-cache',
                        redirect: 'follow',
                        body: JSON.stringify(formData),
                    });
                    
                    // no-cors 모드에서는 응답을 직접 읽을 수 없으므로 성공으로 간주하고 UI를 업데이트
                    showStatus('재고 처리가 요청되었습니다. 잠시 후 반영됩니다.', false);
                    inventoryForm.reset();
                    document.getElementById('productId').focus();

                    // 잠시 후 재고 정보를 다시 불러와서 화면 갱신
                    setTimeout(() => {
                        fetchInventory(currentScannedLocation);
                    }, 2000);

                } catch (error) {
                    console.error('Submit inventory error:', error);
                    showStatus('재고 처리 중 오류가 발생했습니다.', true);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = '처리 완료';
                }
            });

            // 바코드 생성기
            generateBarcodeBtn.addEventListener('click', () => {
                const value = barcodeValueInput.value.trim();
                if (value) {
                    JsBarcode("#barcode", value, {
                        format: "CODE128",
                        lineColor: "#000",
                        width: 2,
                        height: 80,
                        displayValue: true
                    });
                    barcodeContainer.classList.remove('items-center');
                } else {
                    alert('바코드로 만들 값을 입력해주세요.');
                }
            });

            // 초기화
            loadUrl();
            switchTab('manager');
        });
    </script>
</body>
</html>
