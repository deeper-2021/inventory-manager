<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>바코드 재고 관리 시스템</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JsBarcode library for generating barcodes -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- Instascan library for barcode scanning -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/3.3.3/adapter.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.10/vue.min.js"></script>
    <script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <style>
        /* Custom styles for better UI */
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active {
            border-bottom: 2px solid #3B82F6;
            color: #3B82F6;
            font-weight: 600;
        }
        .tab-button {
            border-bottom: 2px solid transparent;
        }
        #preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }
        .scanner-active {
            border: 4px solid #3B82F6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-xl mx-auto p-4 space-y-6">
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-900">바코드 재고 관리</h1>
            <p class="text-gray-600 mt-1">창고 선반 재고를 간편하게 관리하세요.</p>
        </header>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow">
            <div class="flex border-b border-gray-200">
                <button @click="activeTab = 'manager'" :class="{'active': activeTab === 'manager'}" class="tab-button w-1/2 p-4 text-center text-gray-500 transition">
                    재고 관리
                </button>
                <button @click="activeTab = 'generator'" :class="{'active': activeTab === 'generator'}" class="tab-button w-1/2 p-4 text-center text-gray-500 transition">
                    바코드 생성기
                </button>
                 <button @click="activeTab = 'settings'" :class="{'active': activeTab === 'settings'}" class="tab-button w-1/2 p-4 text-center text-gray-500 transition">
                    설정
                </button>
            </div>

            <!-- Content panels -->
            <div class="p-6">
                <!-- Inventory Management Tab -->
                <div v-show="activeTab === 'manager'" class="space-y-6">
                    <!-- ★★★ PC 조회 기능 섹션 ★★★ -->
                    <div class="space-y-2">
                        <label for="manualLocationId" class="font-semibold text-gray-700">위치 ID로 조회:</label>
                        <div class="flex space-x-2">
                            <input type="text" id="manualLocationId" v-model="manualLocationId" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="예: A-01-01">
                            <button @click="fetchInventoryByManualInput" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition">
                                조회
                            </button>
                        </div>
                    </div>
                    <hr>
                    <!-- Barcode Scanner Section -->
                    <div class="text-center space-y-4">
                        <video id="preview" :class="{'scanner-active': isScanning}"></video>
                        <button @click="toggleScan" class="w-full px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition">
                            {{ isScanning ? '스캔 중지' : '카메라로 위치/제품 스캔' }}
                        </button>
                        <p class="text-sm text-gray-500">위치 바코드를 먼저 스캔한 후, 제품 바코드를 스캔하세요.</p>
                    </div>

                    <!-- Scanned Info & Action Form -->
                    <div v-if="scannedLocation || currentInventory.length > 0" class="bg-gray-50 p-4 rounded-lg shadow-inner space-y-4">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">선택된 위치: <span class="text-blue-600">{{ scannedLocation }}</span></h3>
                            
                            <!-- Current Inventory Display -->
                            <div class="mt-4">
                                <h4 class="font-semibold text-gray-700">현재 재고 현황:</h4>
                                <div v-if="loadingInventory" class="text-center py-4">
                                    <p class="text-gray-500">재고 정보를 불러오는 중...</p>
                                </div>
                                <div v-else-if="currentInventory.length > 0" class="mt-2 space-y-2 max-h-48 overflow-y-auto">
                                    <div v-for="item in currentInventory" class="flex justify-between items-center bg-white p-2 rounded-md border">
                                        <div>
                                            <p class="font-semibold text-sm">{{ item.ProductName }} ({{ item.ProductID }})</p>
                                        </div>
                                        <p class="font-bold text-blue-600 text-lg">{{ item.Quantity }}</p>
                                    </div>
                                </div>
                                <div v-else class="text-center py-4 bg-white rounded-md border">
                                    <p class="text-gray-500">해당 위치에 재고가 없습니다.</p>
                                </div>
                            </div>
                        </div>
                        
                        <hr>

                        <!-- Product Info and Action -->
                        <div class="space-y-4">
                             <h4 class="font-semibold text-gray-700">제품 정보 입력:</h4>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">제품 바코드</label>
                                <input type="text" v-model="form.productId" placeholder="스캔 또는 직접 입력" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">제품명</label>
                                <input type="text" v-model="form.productName" placeholder="제품 이름 입력" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">수량</label>
                                <input type="number" v-model.number="form.quantity" placeholder="1" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                            </div>

                            <div class="flex space-x-2">
                                <button @click="submitStock('IN')" class="w-full py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition">입고</button>
                                <button @click="submitStock('OUT')" class="w-full py-3 bg-red-500 text-white font-bold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 transition">출고</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barcode Generator Tab -->
                <div v-show="activeTab === 'generator'" class="space-y-6">
                    <h2 class="text-xl font-bold text-center">위치 바코드 생성기</h2>
                    <div class="grid grid-cols-3 gap-2">
                         <div>
                            <label class="block text-sm font-medium text-gray-600">구역</label>
                            <input type="text" v-model="barcode.zone" maxlength="1" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm uppercase" placeholder="A">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600">선반</label>
                            <input type="number" v-model="barcode.rack" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600">층</label>
                            <input type="number" v-model="barcode.floor" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="01">
                        </div>
                    </div>
                    <div class="text-center bg-gray-100 p-4 rounded-lg">
                        <p class="text-gray-600">생성될 ID</p>
                        <p class="text-2xl font-mono font-bold">{{ generatedBarcodeId }}</p>
                    </div>
                    <div class="flex justify-center">
                         <svg id="barcode"></svg>
                    </div>
                     <button @click="printBarcode" class="w-full py-3 bg-gray-700 text-white font-bold rounded-lg shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 transition">인쇄</button>
                </div>

                <!-- Settings Tab -->
                <div v-show="activeTab === 'settings'" class="space-y-6">
                    <h2 class="text-xl font-bold text-center">설정</h2>
                    <div>
                        <label for="apiUrl" class="block text-sm font-medium text-gray-700">Google Apps Script URL</label>
                        <input type="url" id="apiUrl" v-model="apiUrl" placeholder="https://script.google.com/macros/s/..." class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="mt-2 text-xs text-gray-500">Google 스프레드시트에서 배포한 웹 앱 URL을 입력하세요.</p>
                    </div>
                    <button @click="saveSettings" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">설정 저장</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div v-if="toast.show" class="fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg text-white" :class="toast.type === 'success' ? 'bg-green-500' : 'bg-red-500'">
            {{ toast.message }}
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                activeTab: 'manager',
                apiUrl: '',
                // Scanner data
                scanner: null,
                activeCameraId: null,
                cameras: [],
                isScanning: false,
                scannedLocation: '',
                // Form data
                form: {
                    productId: '',
                    productName: '',
                    quantity: 1
                },
                // Barcode generator data
                barcode: {
                    zone: 'A',
                    rack: 1,
                    floor: 1
                },
                // Inventory data
                currentInventory: [],
                loadingInventory: false,
                // PC manual lookup
                manualLocationId: '',
                // Toast notification
                toast: {
                    show: false,
                    message: '',
                    type: 'success'
                }
            },
            computed: {
                generatedBarcodeId() {
                    const rack = this.barcode.rack.toString().padStart(2, '0');
                    const floor = this.barcode.floor.toString().padStart(2, '0');
                    return `${this.barcode.zone.toUpperCase()}-${rack}-${floor}`;
                }
            },
            watch: {
                generatedBarcodeId(newVal) {
                    if (newVal) {
                        this.$nextTick(() => {
                            JsBarcode("#barcode", newVal, {
                                format: "CODE128",
                                displayValue: true,
                                fontSize: 18,
                                textMargin: 0
                            });
                        });
                    }
                }
            },
            mounted() {
                // Load saved API URL from localStorage
                this.apiUrl = localStorage.getItem('inventoryApiUrl') || '';
                // Initialize barcode scanner
                this.scanner = new Instascan.Scanner({ video: document.getElementById('preview'), scanPeriod: 5 });
                this.scanner.addListener('scan', (content) => {
                    this.handleScan(content);
                });
                Instascan.Camera.getCameras().then(cameras => {
                    this.cameras = cameras;
                    if (cameras.length > 0) {
                        this.activeCameraId = cameras[0].id;
                        if(this.isScanning) this.startScan(); // Start scan if it was active
                    } else {
                        console.error('No cameras found.');
                        this.showToast('카메라를 찾을 수 없습니다.', 'error');
                    }
                }).catch(e => console.error(e));
                 // Initial barcode generation
                this.$nextTick(() => {
                    JsBarcode("#barcode", this.generatedBarcodeId);
                });
            },
            methods: {
                showToast(message, type = 'success') {
                    this.toast.message = message;
                    this.toast.type = type;
                    this.toast.show = true;
                    setTimeout(() => {
                        this.toast.show = false;
                    }, 3000);
                },
                saveSettings() {
                    localStorage.setItem('inventoryApiUrl', this.apiUrl);
                    this.showToast('설정이 저장되었습니다.');
                },
                toggleScan() {
                    this.isScanning = !this.isScanning;
                    if (this.isScanning) {
                        this.startScan();
                    } else {
                        this.stopScan();
                    }
                },
                startScan() {
                    if (this.cameras.length === 0) {
                        this.showToast('사용 가능한 카메라가 없습니다.', 'error');
                        this.isScanning = false;
                        return;
                    }
                    this.scanner.start(this.cameras[0]);
                },
                stopScan() {
                    this.scanner.stop();
                },
                handleScan(content) {
                    // Check if the scanned content matches the location ID format (e.g., A-01-01)
                    if (/^[A-Z]-\d{2}-\d{2}$/.test(content)) {
                        this.scannedLocation = content;
                        this.showToast(`위치 '${content}'가 선택되었습니다.`);
                        this.fetchInventory(content);
                    } else {
                        this.form.productId = content;
                        this.showToast(`제품 '${content}'가 스캔되었습니다.`);
                    }
                },
                fetchInventory(locationId) {
                    if (!this.apiUrl) {
                        this.showToast('API URL이 설정되지 않았습니다.', 'error');
                        return;
                    }
                    if (!locationId) return;

                    this.loadingInventory = true;
                    this.currentInventory = [];
                    
                    fetch(`${this.apiUrl}?location=${locationId}`, { method: 'GET' })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.error) {
                                throw new Error(data.error);
                            }
                            this.currentInventory = data.inventory || [];
                        })
                        .catch(error => {
                            console.error('Error fetching inventory:', error);
                            this.showToast('재고 정보를 불러오는데 실패했습니다.', 'error');
                        })
                        .finally(() => {
                             this.loadingInventory = false;
                        });
                },
                fetchInventoryByManualInput() {
                    const locationId = this.manualLocationId.trim().toUpperCase();
                    if (!locationId) {
                        this.showToast('조회할 위치 ID를 입력하세요.', 'error');
                        return;
                    }
                    this.scannedLocation = locationId;
                    this.fetchInventory(locationId);
                },
                submitStock(action) {
                    if (!this.apiUrl) {
                        this.showToast('API URL이 설정되지 않았습니다.', 'error');
                        return;
                    }
                    if (!this.scannedLocation || !this.form.productId || !this.form.productName || this.form.quantity <= 0) {
                        this.showToast('위치, 제품 정보, 수량을 모두 입력하세요.', 'error');
                        return;
                    }

                    const payload = {
                        locationId: this.scannedLocation,
                        productId: this.form.productId,
                        productName: this.form.productName,
                        quantity: this.form.quantity,
                        action: action // 'IN' or 'OUT'
                    };

                    fetch(this.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8', // Apps Script web apps often expect text/plain for doPost
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            this.showToast(`'${this.form.productName}' ${action === 'IN' ? '입고' : '출고'} 처리 완료!`);
                            // Refresh inventory for the current location
                            this.fetchInventory(this.scannedLocation);
                            // Reset form fields
                            this.form.productId = '';
                            this.form.productName = '';
                            this.form.quantity = 1;
                        } else {
                             throw new Error(data.error || 'Unknown error');
                        }
                    })
                    .catch(error => {
                        console.error('Error submitting stock:', error);
                        this.showToast('데이터 처리 중 오류가 발생했습니다.', 'error');
                    });
                },
                printBarcode() {
                    const barcodeSVG = document.getElementById('barcode').outerHTML;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                            <head><title>Print Barcode</title></head>
                            <body style="text-align:center; margin-top: 50px;">
                                ${barcodeSVG}
                                <script>
                                    window.onload = function() {
                                        window.print();
                                        window.close();
                                    }
                                <\/script>
                            </body>
                        </html>
                    `);
                    printWindow.document.close();
                }
            }
        });
    </script>
</body>
</html>

